<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perlin Noise Avatar Generator with Face</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .hidden {
            display: none;
        }
        #avatarOptions img {
            margin: 0 10px;
        }
        #avatar {
            width: 200px;
            height: 200px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        input, button {
            margin-top: 10px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
</head>
<body>
    <div id="step1">
        <h2>Enter your email</h2>
        <input type="text" id="emailInput" placeholder="Enter your email">
        <button onclick="goToStep2()">Next</button>
    </div>
    <div id="step2" class="hidden">
        <h2>Select an avatar or skip</h2>
        <div id="avatarOptions">
            <!-- Avatar options will be dynamically added here -->
        </div>
        <button onclick="generateAvatar()">Skip</button>
    </div>
    <div id="step3" class="hidden">
        <div id="avatar"></div>
        <button onclick="saveAvatar()">Save Avatar</button>
    </div>

    <script>
        const gridSize = 10;
        const cellSize = 20; // 200px / 10 cells
        const svgNS = "http://www.w3.org/2000/svg";
        const noise = new SimplexNoise();

        function getRandomColors() {
            const colors = [];
            for (let i = 0; i < 3; i++) {
                colors.push(`hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`);
            }
            return colors;
        }

        function goToStep2() {
            const email = document.getElementById('emailInput').value;
            if (email) {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                generateAvatarOptions();
            } else {
                alert('Please enter an email');
            }
        }

        function generateAvatarOptions() {
            const avatarOptionsDiv = document.getElementById('avatarOptions');
            avatarOptionsDiv.innerHTML = '';
            for (let i = 0; i < 5; i++) { // Generate 5 example avatars
                const svg = generateAvatarSVG();
                const img = document.createElement('img');
                img.src = svgToBase64(svg);
                img.onclick = () => selectAvatar(svg);
                avatarOptionsDiv.appendChild(img);
            }
        }

        function generateAvatar() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');

            const svg = generateAvatarSVG();
            const avatarDiv = document.getElementById('avatar');
            avatarDiv.innerHTML = '';
            avatarDiv.appendChild(svg);
        }

        function selectAvatar(svg) {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
            const avatarDiv = document.getElementById('avatar');
            avatarDiv.innerHTML = '';
            avatarDiv.appendChild(svg);
        }

        function generateAvatarSVG() {
            const colors = getRandomColors();
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("width", gridSize * cellSize);
            svg.setAttribute("height", gridSize * cellSize);
            svg.setAttribute("viewBox", `0 0 ${gridSize * cellSize} ${gridSize * cellSize}`);

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const value = noise.noise2D(x / gridSize, y / gridSize);
                    const color = valueToColor(value, colors);
                    drawCell(svg, x, y, color);
                }
            }

            // Overlay face template
            overlayFaceTemplate(svg);

            return svg;
        }

        function overlayFaceTemplate(svg) {
            // Define face template (eyes, nose, mouth)
            const eyeRadius = cellSize / 4;
            const eyeY = cellSize * 2.5;
            const leftEyeX = cellSize * 3;
            const rightEyeX = cellSize * 7;

            const noseWidth = cellSize;
            const noseHeight = cellSize / 2;
            const noseX = (gridSize / 2) * cellSize - noseWidth / 2;
            const noseY = cellSize * 4.5;

            const mouthWidth = cellSize * 3;
            const mouthHeight = cellSize / 4;
            const mouthX = (gridSize / 2) * cellSize - mouthWidth / 2;
            const mouthY = cellSize * 7;

            // Draw eyes
            drawCircle(svg, leftEyeX, eyeY, eyeRadius, "white");
            drawCircle(svg, rightEyeX, eyeY, eyeRadius, "white");

            // Draw nose
            drawRect(svg, noseX, noseY, noseWidth, noseHeight, "white");

            // Draw mouth
            drawRect(svg, mouthX, mouthY, mouthWidth, mouthHeight, "white");
        }

        function drawCircle(svg, cx, cy, r, fill) {
            const circle = document.createElementNS(svgNS, "circle");
            circle.setAttribute("cx", cx);
            circle.setAttribute("cy", cy);
            circle.setAttribute("r", r);
            circle.setAttribute("fill", fill);
            svg.appendChild(circle);
        }

        function drawRect(svg, x, y, width, height, fill) {
            const rect = document.createElementNS(svgNS, "rect");
            rect.setAttribute("x", x);
            rect.setAttribute("y", y);
            rect.setAttribute("width", width);
            rect.setAttribute("height", height);
            rect.setAttribute("fill", fill);
            svg.appendChild(rect);
        }

        function valueToColor(value, colors) {
            const normalizedValue = (value + 1) / 2; // Normalize value to range 0-1
            const index = Math.floor(normalizedValue * colors.length);
            return colors[Math.min(index, colors.length - 1)];
        }

        function drawCell(svg, x, y, color) {
            const rect = document.createElementNS(svgNS, "rect");
            rect.setAttribute("x", x * cellSize);
            rect.setAttribute("y", y * cellSize);
            rect.setAttribute("width", cellSize);
            rect.setAttribute("height", cellSize);
            rect.setAttribute("fill", color);
            svg.appendChild(rect);
        }

        function svgToBase64(svg) {
            const svgString = new XMLSerializer().serializeToString(svg);
            const base64 = window.btoa(unescape(encodeURIComponent(svgString)));
            return `data:image/svg+xml;base64,${base64}`;
        }

        function saveAvatar() {
            const svg = document.querySelector('#avatar svg');
            const base64Image = svgToBase64(svg);
            console.log('Avatar saved:', base64Image);
            // Additional code to handle saving the avatar can be added here
        }
    </script>
</body>
</html>